#!/bin/bash

# ------ Change this if you need it -------------------------- #
rpc_cmd() { 
    rpcclient -U "" -N 10.10.10.161 "$@" 
}

# ------ Now, dont touch anything ---------------------------- # 
GREEN="\e[0;32m\033[1m"; RED="\e[0;31m\033[1m"; YLLW="\e[0;33m\033[1m"; GRAY="\e[0;37m\033[1m"; ENDC="\033[0m\e[0m"; BOLD="\e[7m"; ENDB="\e[27m"

sid=$(rpc_cmd -c "lsaquery" | grep "Sid" | awk '{print $2}' FS=":")
echo -e "${YLLW}\n[*] Domain SID: ${ENDC} $sid"; 

echo -e "${YLLW}\n[*] Enumerating domain users: ${ENDC}"; badusers="SM|Mailbox"
declare -a users=$(rpc_cmd -c "enumdomusers" | grep -oP "\[.*?\]" | grep -vE "0x|$badusers" | tr -d "[]")
for user in $users; do
    rpc_cmd -c "queryuser $user" | grep -E "User Name|Description|user_rid" &&
    rid_hex=$(rpc_cmd -c "queryuser $user" | grep "user_rid" | awk '{print $2}' FS=":"); 
    rid_decimal=$(printf "%d\n" "$rid_hex") && echo -e "\tSID: $sid-$rid_decimal" &&
    echo -e "\t━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━";
done
echo -e "${YLLW}\n[*] New users file created: 'users.txt': ${ENDC}"; echo $users | sed 's/ /\n/g' >> users.txt

echo -e "${YLLW}\n[*] SIDs bruteforce: ${ENDC}";  
for i in $(seq 500 1000); do
 rpc_cmd -c "lookupsids $sid-$i;quit" | grep -v "unknown"
done

rpc_cmd -c "srvinfo" &>/dev/null
if [ $? -ne 0 ]; then echo -e "${YLLW}\n[!] No server info available${ENDC}"
else 
    echo -e "${YLLW}\n[*] Info about the server?:${ENDC}"; rpc_cmd -c "srvinfo" 2>/dev/null 
fi

echo -e "${YLLW}\n[*] Enumerating groups: ${ENDC}"
declare -a groups=($(rpc_cmd -c "enumdomgroups" | grep -oP "\[.*?\]" | grep -v 0x | tr -d "[]" | tr -d " "))
declare -a rids=($(rpc_cmd -c "enumdomgroups" | grep -oP "\[.*?\]" | grep 0x | tr -d "[]"))

longitud=${#rids[@]}
for ((i=0; i<$longitud; i++)); do
    grupo=${groups[i]}; rid=${rids[i]}; echo -e "${RED}\t> Group: $grupo  (RID: $rid)${ENDC}"
    declare -a memrids=($(rpc_cmd -c "querygroupmem $rid" | grep -oP 'rid:\[\K0x[0-9a-fA-F]+'))
    for a in ${memrids[@]}; do
        echo -e "\t$(rpc_cmd -c "queryuser $a" | grep -E "$filter" | grep "User Name" | awk '{print $2}' FS=":")"
    done
done
