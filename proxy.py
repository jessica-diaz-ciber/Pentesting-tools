#!/usr/bin/python3
######## GLOBALES A EDITAR POR EL USUARIO ###################
TIMEOUT = 4
VERBOSE = False
RCV_FIRST = True
#############################################################

import sys, socket, threading

YLW = "\033[1;33m"; BLU = "\033[1;36m"; END = "\033[0m"
HEX_FILTER = ''.join([ (len(repr(chr(i))) == 3 ) and chr(i) or '.' for i in range(256) ])

def hexdump(src, lenght=16, show=True):
    src = src.decode('utf-8')
    if isinstance(src,bytes):
        scr = src.decode()
    results = list()
    for i in range(0, len(src), lenght):
        word = str(src[i:i+lenght]); printable = word.translate(HEX_FILTER)
        hexa = ' '.join([ f'{ord(c):02X}' for c in word ]); hexwidth = lenght*3
        results.append(f'{i:04X} {hexa:<{hexwidth}} : {printable}')
    if show:
        for line in results:
            print(line)
    else:
        return results

def receive_from(conn):  ## recibe data todo el rato y la mete en el buffer
    buffer = b""; conn.settimeout(TIMEOUT)
    try:
        while True:
            data = conn.recv(4096)
            if not data:
                break
            buffer += data
    except Exception as e:
        print(f"  {e}")
        pass
    return buffer

def request_handler(buffer):
    return buffer
def response_handler(buffer):
    return buffer

## Proceso hijo --->   socket localhost (cli_sock)    socket remoto (r_sock), ambos en escucha
def proxy_handler(cli_sock, rhost, rport):
    r_sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)
    r_sock.connect((rhost,rport))
    if RCV_FIRST == True:
        r_buff = receive_from(r_sock)
        if len(r_buff):
            print(f"[<==] Received {len(r_buff)} bytes from remote"); 
            print("-"*24); print(r_buff.decode('utf-8').replace('\\n','\n')); print("-"*24); 
            if VERBOSE == True:
                hexdump(r_buff)
            r_buff = response_handler(r_buff); cli_sock.send(r_buff); print("[==>] Send to local")

    while True:  ## todo el rato escucha en el buffer local y despues el remoto
        l_buff = receive_from(cli_sock)
        if len(l_buff):
            print(f"{YLW}[==>] Received {len(l_buff)} bytes from localhost."); 
            print("--"*12); print(l_buff.decode('utf-8').replace('\\n','\n')); print("--"*12); 
            if VERBOSE == True:
                hexdump(l_buff)
            l_buff = request_handler(l_buff); r_sock.send(l_buff); print("[==>] Sent to remote")

        r_buff = receive_from(r_sock)
        if len(r_buff):
            print(f"{BLU}[<==] Received {len(r_buff)} bytes from remote"); 
            print("-"*24); print(r_buff.decode('utf-8').replace('\\n','\n')); print("-"*24); 
            if VERBOSE == True:
                hexdump(r_buff)
            r_buff = response_handler(r_buff); cli_sock.send(r_buff); print("[==>] Send to local")

        if not len(l_buff) or not len(r_buff):
            cli_sock.close(); r_sock.close(); print(f"{END}No more data"); sys.exit(0)
            break
    
def server_loop(lhost,lport,rhost,rport):
    server = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
    try:
        server.bind((lhost,lport))
    except Exception as e:
        print(f"[!!] Failed to listen on {lhost}:{lport}. Exception {e}"); sys.exit(0)
    print(f"[*] Listening on {lhost}:{lport}"); server.listen(5)
    while True:
        cli_sock, addr = server.accept()
        print(f"[==>] Received incoming connection from {addr[0]}:{addr[1]}")  ## escucha (cli_sock)
        prxy_thd = threading.Thread(target=proxy_handler,args=(cli_sock,rhost,rport)); prxy_thd.start()

def main():
    if len(sys.argv[1:]) != 4:
        print(f"Usage: ./proxy.py [lhost] [lport] [rhost] [rport] [rcv_first]")
        print(f"Example: ./proxy.py 127.0.0.1 9000 10.12.132.1 9000 True")
        sys.exit(0)
    lhost = sys.argv[1]; lport = int(sys.argv[2]); rhost = sys.argv[3]; rport = int(sys.argv[4])
    server_loop(lhost,lport,rhost,rport)

main()

## Ejemplo -> ./proxy.py 127.0.0.1 9005 info.cern.ch 80 True 
## └─$ nc 127.0.0.1 9005 -> GET / HTTP/v1.1

