#!/bin/bash


GREEN="\e[0;32m\033[1m"; RED="\e[0;31m\033[1m"; YLLW="\e[0;33m\033[1m"; GRAY="\e[0;37m\033[1m"; 
ENDC="\033[0m\e[0m"; BOLD="\e[7m"; ENDB="\e[27m"

echo -e "${YLLW}\n\t[*] Instalando paquetes: ${ENDC}"; 

apt install openvpn easy-rsa ufw moreutils -y # Instalar paquetes
make-cadir ~/openvpn-ca && cd ~/openvpn-ca
VARS_FILE="./vars"; PKI="/root/openvpn-ca/pki"
OPENVPN_DIR="/etc/openvpn"; CLIENT_DIR="${OPENVPN_DIR}/client"; 
CLIENT_FILE="${CLIENT_DIR}/client.conf"; SERVER_FILE="${OPENVPN_DIR}/server.conf"
CLIENT_KEY="${CLIENT_DIR}/cliente1.ovpn"


echo -e "${YLLW}\n\t[*] Creando certificados: ${ENDC}"; 
echo -e "${YLLW}\n > Cuando pregunte por passfrase ponemos una contraseña, corta y simple por favor ${ENDC}"; 
echo -e "${YLLW}\n > Cuando pregunte por nombre de la organización lo dejamos en blanco ${ENDC}"; 
sleep 3

echo "" > "$VARS_FILE"
cat <<EOF >> "$VARS_FILE"
set_var EASYRSA_REQ_COUNTRY     "ES"
set_var EASYRSA_REQ_PROVINCE    "Pais Vasco"
set_var EASYRSA_REQ_CITY        "Bizcaya"
set_var EASYRSA_REQ_ORG         "CIBERSARE"
EOF

./easyrsa init-pki && ./easyrsa build-ca && ./easyrsa gen-req server nopass 
./easyrsa sign-req server server && ./easyrsa gen-dh && openvpn --genkey --secret pki/ta.key 

echo -e "${YLLW}\n\t[*] Creando archivo de configuración del servidor en ${SERVER_FILE}: ${ENDC}"; 
sleep 2

cp ${PKI}/private/server.key ${PKI}/ca.crt ${PKI}/issued/server.crt ${PKI}/dh.pem ${PKI}/ta.key /etc/openvpn/  
touch ${SERVER_FILE}
cat <<EOF > "$SERVER_FILE"
port 1194
proto udp
dev tun
ca ca.crt
cert server.crt
key server.key  # This file should be kept secret
dh dh.pem
tls-crypt ta.key 
topology subnet
server 10.8.0.0 255.255.255.0
ifconfig-pool-persist /var/log/openvpn/ipp.txt
keepalive 10 120
persist-key
persist-tun
status /var/log/openvpn/openvpn-status.log
verb 3
explicit-exit-notify 1
EOF

echo -e "${YLLW}\n\t[*] Arrancando el servicio y ajustando el firewall: ${ENDC}"; 
echo -e "${YLLW}\n > Interfaz de la vpn: tun0 ${ENDC}"; 
sleep 3

echo net.ipv4.ip_forward=1 > /etc/sysctl.conf && sysctl -p
ufw allow 1194/udp && ufw allow OpenSSH
iptables -t nat -A POSTROUTING -s 10.8.0.0/24 -o tun0 -j MASQUERADE
systemctl start openvpn@server && systemctl enable openvpn@server

# -------------- CLIENT -------------------------- #

echo -e "${YLLW}\n\t[*] Creando los archivos del cliente en ${CLIENT_FILE}: ${ENDC}"; 
echo -e "${YLLW}\n > Os preguntarán por la contraseña de antes ${ENDC}"; 
sleep 2


cd ~/openvpn-ca && ./easyrsa build-client-full cliente1 nopass
cp ${PKI}/issued/cliente1.crt ${PKI}/reqs/cliente1.req ${PKI}/private/cliente1.key ${CLIENT_DIR}/
touch ${CLIENT_FILE}

cat <<EOF > "${CLIENT_FILE}"
client
dev tun
proto udp
remote 192.168.159.142 1194
resolv-retry infinite
nobind
persist-key
persist-tun
remote-cert-tls server
verb 3
EOF

cat ${CLIENT_FILE} <(echo -e '<ca>') ${OPENVPN_DIR}/ca.crt <(echo -e '</ca>\n<cert>') \
    ${CLIENT_DIR}/cliente1.crt  <(echo -e '</cert>\n<key>') \
    ${CLIENT_DIR}/cliente1.key  <(echo -e '</key>\n<tls-crypt>') \
    ${OPENVPN_DIR}/ta.key  <(echo -e '</tls-crypt>') > ${CLIENT_KEY}


echo -e "${YLLW}\n\t[*] Creando el archivo del cliente en ${CLIENT_KEY} : ${ENDC}"; 
echo -e "${YLLW}\n > Abrirlo y cambiar la ip del servidor por la que corresponda ${ENDC}"; 
echo -e "${YLLW}\n > Es decir editar esta linea ->>>> remote 192.168.159.142 1194  ${ENDC}"; 
sleep 5